<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>게시글 상세 보기 - Doogle</title>
    <style>
      /* CSS 스타일은 main.html의 스타일을 기반으로 적용합니다. */
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap");

      :root {
        --google-blue: #4285f4;
        --google-dark-text: #202124;
        --google-light-text: #5f6368;
        --background-color: #f8f9fa;
        --google-red: #ea4335; /* 삭제 버튼 색상 변수화 */
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--background-color);
        margin: 0;
        padding: 0;
      }

      /* App Bar 및 버튼 스타일 통일 */
      .app-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background-color: #fff;
        border-bottom: 1px solid #dadce0;
      }

      /* ★★★ 로고 스타일 복구 및 통일 ★★★ */
      .logo-text {
        font-size: 24px;
        font-weight: 500;
      }
      .logo-text span:nth-child(1) {
        color: #4285f4;
      }
      .logo-text span:nth-child(2) {
        color: #ea4335;
      } /* o */
      .logo-text span:nth-child(3) {
        color: #fbbc05;
      } /* o */
      .logo-text span:nth-child(4) {
        color: #4285f4;
      } /* g */
      .logo-text span:nth-child(5) {
        color: #34a853;
      } /* l (e는 없으므로 d,o,o,g,l,e 순으로 색상 배열) */

      .main-content {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .primary-btn {
        padding: 10px 24px;
        background-color: var(--google-blue);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .primary-btn:hover {
        background-color: #357ae8;
      }
      .secondary-btn {
        padding: 10px 24px;
        background-color: #fff;
        color: var(--google-dark-text);
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .secondary-btn:hover {
        background-color: #f0f0f0;
      }

      /* 게시글 상세 스타일 */
      .post-detail-card {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* ★★★ 제목 스타일 수정: 두꺼운 선 대신 얇은 선 사용 ★★★ */
      #postTitle {
        color: var(--google-dark-text);
        font-size: 28px; /* 제목 크기 키움 */
        font-weight: 500;
        margin-top: 0;
        margin-bottom: 10px;
      }

      /* 제목과 메타 정보 사이에 얇은 회색 구분선 추가 */
      .post-header-area {
        border-bottom: 1px solid #dadce0;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      #postMeta {
        font-size: 14px;
        color: var(--google-light-text);
        /* 기존 padding-bottom과 margin-bottom은 post-header-area로 통합 */
      }

      #postText {
        line-height: 1.8;
        color: var(--google-dark-text);
        white-space: pre-wrap;
        font-size: 16px;
      }

      .action-buttons {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
        text-align: right;
      }

      /* 삭제 버튼 스타일 변수 사용 */
      #deleteBtn {
        background-color: var(--google-red) !important;
      }

      .action-buttons button {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app-bar">
      <a href="main.html" style="text-decoration: none">
        <div class="logo-text">
          <span>D</span><span>o</span><span>o</span><span>g</span><span>l</span
          ><span>e</span>
        </div>
      </a>
      <div class="user-info">
        <span id="welcomeUser" style="color: var(--google-dark-text)"
          >로딩 중...</span
        >
        <button class="secondary-btn" id="logoutBtn">로그아웃</button>
      </div>
    </div>

    <div class="main-content">
      <div id="authStatus" style="display: none"></div>

      <div class="post-detail-card">
        <div class="post-header-area">
          <h1 id="postTitle">게시글 제목 로딩 중...</h1>
          <p id="postMeta">작성자: ... | 작성 시간: ...</p>
        </div>

        <div id="postText">내용을 불러오는 중입니다.</div>

        <div class="action-buttons">
          <button class="secondary-btn" id="editBtn" style="display: none">
            수정
          </button>
          <button class="primary-btn" id="deleteBtn" style="display: none">
            삭제
          </button>
          <button
            class="secondary-btn"
            id="listBtn"
            onclick="window.location.href='main.html';"
          >
            목록으로
          </button>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://127.0.0.1:8080";
      let loggedInUserid = null; // 현재 로그인된 사용자 ID 저장

      // ------------------------------------------------------------------
      // 유틸리티 함수
      // ------------------------------------------------------------------
      function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function getPostIdxFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("idx");
      }

      // ------------------------------------------------------------------
      // 게시글 상세 정보 불러오기
      // ------------------------------------------------------------------
      async function fetchAndRenderPost(idx) {
        const token = localStorage.getItem("token");

        if (!token) {
          alert(
            "인증 정보가 없어 게시글을 볼 수 없습니다. 로그인 페이지로 이동합니다."
          );
          window.location.href = "index.html";
          return;
        }

        try {
          // GET /post/:idx 엔드포인트 호출
          const response = await fetch(`${BASE_URL}/post/${idx}`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 404) {
            document.getElementById("postTitle").textContent =
              "게시글을 찾을 수 없습니다.";
            document.getElementById("postMeta").textContent =
              "존재하지 않거나 삭제된 게시글입니다.";
            document.getElementById("postText").textContent = "";
            return;
          }

          if (!response.ok) {
            throw new Error(`게시글 로딩 실패: ${response.statusText}`);
          }

          const post = await response.json();
          renderPost(post);
        } catch (error) {
          console.error("게시글 상세 로딩 실패:", error);
          document.getElementById(
            "postText"
          ).textContent = `오류 발생: ${error.message}`;
        }
      }

      // ------------------------------------------------------------------
      // 상세 정보 렌더링 및 버튼 표시 결정
      // ------------------------------------------------------------------
      function renderPost(post) {
        document.getElementById("postTitle").textContent = post.title;
        document.getElementById("postText").textContent = post.text;

        const metaText = `
              작성자: ${post.name} (${post.userid}) | 
              작성 시간: ${formatDateTime(post.createdAt)} | 
              수정 시간: ${formatDateTime(post.updatedAt)}
          `;
        document.getElementById("postMeta").innerHTML = metaText;

        // 작성자 권한 체크 및 버튼 표시
        const isPostOwner = loggedInUserid === post.userid;
        if (isPostOwner) {
          const editBtn = document.getElementById("editBtn");
          const deleteBtn = document.getElementById("deleteBtn");

          editBtn.style.display = "inline-block";
          deleteBtn.style.display = "inline-block";

          // 이벤트 리스너 연결
          editBtn.addEventListener("click", () => editPostHandler(post.idx));
          deleteBtn.addEventListener("click", () =>
            deletePostHandler(post.idx)
          );
        }
      }

      // ------------------------------------------------------------------
      // 인증 체크 (main.html과 동일)
      // ------------------------------------------------------------------
      async function checkAuthAndLoadPost() {
        const token = localStorage.getItem("token");
        const welcomeElement = document.getElementById("welcomeUser");
        const postIdx = getPostIdxFromUrl();

        if (!postIdx) {
          document.getElementById("postTitle").textContent = "잘못된 접근";
          document.getElementById("postMeta").textContent =
            "게시글 ID(idx)가 URL에 없습니다.";
          return;
        }

        if (!token) {
          // 토큰이 없으면 loadPost 내부에서 리디렉션 처리
          fetchAndRenderPost(postIdx);
          return;
        }

        try {
          const response = await fetch(`${BASE_URL}/auth/me`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (response.ok) {
            // 인증 성공
            welcomeElement.textContent = `${result.userid}님, 환영합니다!`;
            loggedInUserid = result.userid; // 사용자 ID 저장
            fetchAndRenderPost(postIdx); // 게시글 로드 시작
          } else {
            // 인증 실패 시 토큰 제거 및 로그인 페이지로 리디렉션
            localStorage.removeItem("token");
            alert("인증 정보가 만료되었습니다. 다시 로그인해주세요.");
            window.location.href = "index.html";
          }
        } catch (error) {
          console.error("인증 중 서버 오류:", error);
          welcomeElement.textContent = `연결 오류`;
          alert("서버 연결에 실패했습니다.");
        }
      }

      // ------------------------------------------------------------------
      // 버튼 핸들러
      // ------------------------------------------------------------------
      function logoutHandler() {
        localStorage.removeItem("token");
        alert("로그아웃되었습니다.");
        window.location.href = "index.html";
      }

      function editPostHandler(idx) {
        // 수정 페이지로 이동 (post_edit.html)
        window.location.href = `post_edit.html?idx=${idx}`;
      }

      async function deletePostHandler(idx) {
        if (!confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
          return;
        }

        const token = localStorage.getItem("token");
        try {
          // DELETE /post/:idx 엔드포인트 호출
          const response = await fetch(`${BASE_URL}/post/${idx}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 204 || response.ok) {
            // 204 No Content 또는 200 OK
            alert("게시글이 성공적으로 삭제되었습니다.");
            window.location.href = "main.html"; // 목록 페이지로 리디렉션
          } else if (response.status === 403) {
            alert("권한이 없습니다. 작성자만 삭제할 수 있습니다.");
          } else {
            const errorResult = await response.json();
            throw new Error(
              errorResult.message || `삭제 실패: ${response.status}`
            );
          }
        } catch (error) {
          console.error("삭제 오류:", error);
          alert(`게시글 삭제 중 오류가 발생했습니다: ${error.message}`);
        }
      }

      // 페이지 로드 시 인증 체크 및 게시글 로드 시작
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("logoutBtn")
          .addEventListener("click", logoutHandler);
        checkAuthAndLoadPost();
      });
    </script>
  </body>
</html>
